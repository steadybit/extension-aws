// SPDX-License-Identifier: MIT
// SPDX-FileCopyrightText: 2024 Steadybit GmbH

package extelasticache

import (
	"context"
	"github.com/aws/aws-sdk-go-v2/service/elasticache"
	"github.com/steadybit/extension-aws/utils"
)

const (
	elasticacheNodeGroupTargetId = "com.steadybit.extension_aws.elasticache.node-group"
)

const (
	elasticacheIcon = "data:image/svg+xml,%3Csvg%20width%3D%2280px%22%20height%3D%2280px%22%20viewBox%3D%220%200%2080%2080%22%20version%3D%221.1%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20xmlns%3Axlink%3D%22http%3A%2F%2Fwww.w3.org%2F1999%2Fxlink%22%3E%0A%20%20%20%20%3C%21--%20Generator%3A%20Sketch%2064%20%2893537%29%20-%20https%3A%2F%2Fsketch.com%20--%3E%0A%20%20%20%20%3Ctitle%3EIcon-Architecture%2F64%2FArch_Amazon-ElastiCache_64%3C%2Ftitle%3E%0A%20%20%20%20%3Cdesc%3ECreated%20with%20Sketch.%3C%2Fdesc%3E%0A%20%20%20%20%3Cdefs%3E%0A%20%20%20%20%20%20%20%20%3ClinearGradient%20x1%3D%220%25%22%20y1%3D%22100%25%22%20x2%3D%22100%25%22%20y2%3D%220%25%22%20id%3D%22linearGradient-1%22%3E%0A%20%20%20%20%20%20%20%20%20%20%20%20%3Cstop%20stop-color%3D%22%232E27AD%22%20offset%3D%220%25%22%3E%3C%2Fstop%3E%0A%20%20%20%20%20%20%20%20%20%20%20%20%3Cstop%20stop-color%3D%22%23527FFF%22%20offset%3D%22100%25%22%3E%3C%2Fstop%3E%0A%20%20%20%20%20%20%20%20%3C%2FlinearGradient%3E%0A%20%20%20%20%3C%2Fdefs%3E%0A%20%20%20%20%3Cg%20id%3D%22Icon-Architecture%2F64%2FArch_Amazon-ElastiCache_64%22%20stroke%3D%22none%22%20stroke-width%3D%221%22%20fill%3D%22none%22%20fill-rule%3D%22evenodd%22%3E%0A%20%20%20%20%20%20%20%20%3Cg%20id%3D%22Icon-Architecture-BG%2F64%2FDatabase%22%20fill%3D%22url%28%23linearGradient-1%29%22%3E%0A%20%20%20%20%20%20%20%20%20%20%20%20%3Crect%20id%3D%22Rectangle%22%20x%3D%220%22%20y%3D%220%22%20width%3D%2280%22%20height%3D%2280%22%3E%3C%2Frect%3E%0A%20%20%20%20%20%20%20%20%3C%2Fg%3E%0A%20%20%20%20%20%20%20%20%3Cpath%20d%3D%22M51%2C61.5554864%20L51%2C55.7029342%20C48.466%2C57.3400887%2043.904%2C58.1131616%2039.556%2C58.1131616%20C34.816%2C58.1131616%2031.121%2C57.2860836%2029%2C55.8679498%20L29%2C61.5554864%20C29%2C63.2486461%2032.948%2C64.9998113%2039.556%2C64.9998113%20C46.3%2C64.9998113%2051%2C63.1846401%2051%2C61.5554864%20L51%2C61.5554864%20Z%20M39.556%2C49.2203227%20C34.816%2C49.2203227%2031.121%2C48.3942447%2029%2C46.976111%20L29%2C52.6866497%20C29.031%2C54.3738088%2032.973%2C56.1129729%2039.556%2C56.1129729%20C46.279%2C56.1129729%2050.969%2C54.3088027%2051%2C52.6826493%20L51%2C46.8100953%20C48.466%2C48.4482498%2043.904%2C49.2203227%2039.556%2C49.2203227%20L39.556%2C49.2203227%20Z%20M51%2C43.7908105%20L51%2C37.0291726%20C48.466%2C38.666327%2043.904%2C39.4393999%2039.556%2C39.4393999%20C34.816%2C39.4393999%2031.121%2C38.613322%2029%2C37.1951882%20L29%2C43.7948108%20C29.031%2C45.48197%2032.973%2C47.220134%2039.556%2C47.220134%20C46.279%2C47.220134%2050.969%2C45.4159638%2051%2C43.7908105%20L51%2C43.7908105%20Z%20M28.997%2C33.9928861%20C28.997%2C33.9958864%2028.998%2C33.9988867%2028.998%2C34.001887%20L29%2C34.001887%20L29%2C34.012888%20C29.031%2C35.7000472%2032.973%2C37.4392112%2039.556%2C37.4392112%20C46.898%2C37.4392112%2050.969%2C35.4170205%2051%2C34.0098877%20L51%2C34.001887%20L51.002%2C34.001887%20C51.002%2C33.9988867%2051.003%2C33.9958864%2051.003%2C33.9928861%20C51.003%2C32.5847533%2046.927%2C30.546561%2039.556%2C30.546561%20C32.946%2C30.546561%2028.997%2C32.2987263%2028.997%2C33.9928861%20L28.997%2C33.9928861%20Z%20M53%2C34.0178885%20L53%2C43.7738088%20L53.003%2C43.7738088%20C53.003%2C43.7828097%2053%2C43.7898104%2053%2C43.7988112%20L53%2C52.6666478%20L53.003%2C52.6666478%20C53.003%2C52.6756486%2053%2C52.6826493%2053%2C52.6916502%20L53%2C61.5554864%20C53%2C65.2968393%2046.031%2C67%2039.556%2C67%20C31.929%2C67%2027%2C64.8627984%2027%2C61.5554864%20L27%2C52.6976507%20C27%2C52.6866497%2026.997%2C52.6776488%2026.997%2C52.6666478%20L27%2C52.6666478%20L27%2C43.8048118%20C27%2C43.7948108%2026.997%2C43.7848099%2026.997%2C43.7738088%20L27%2C43.7738088%20L27%2C34.023889%20C27%2C34.012888%2026.997%2C34.0038872%2026.997%2C33.9928861%20C26.997%2C30.684574%2031.927%2C28.5463723%2039.556%2C28.5463723%20C46.032%2C28.5463723%2053.003%2C30.2505331%2053.003%2C33.9928861%20C53.003%2C34.001887%2053%2C34.0088876%2053%2C34.0178885%20L53%2C34.0178885%20Z%20M67%2C21.1206718%20C67.553%2C21.1206718%2068%2C20.6726295%2068%2C20.1205774%20L68%2C15.0000943%20C68%2C14.4470422%2067.553%2C14%2067%2C14%20L13%2C14%20C12.447%2C14%2012%2C14.4470422%2012%2C15.0000943%20L12%2C20.1205774%20C12%2C20.6726295%2012.447%2C21.1206718%2013%2C21.1206718%20C14.221%2C21.1206718%2015.214%2C22.1077649%2015.214%2C23.3208793%20C15.214%2C24.5339938%2014.221%2C25.5210869%2013%2C25.5210869%20C12.447%2C25.5210869%2012%2C25.9691292%2012%2C26.5211812%20L12%2C47.0031135%20C12%2C47.5551656%2012.447%2C48.0032078%2013%2C48.0032078%20L23%2C48.0032078%20L23%2C46.0030192%20L18%2C46.0030192%20L18%2C43.0027361%20L23%2C43.0027361%20L23%2C41.0025474%20L17%2C41.0025474%20C16.447%2C41.0025474%2016%2C41.4495896%2016%2C42.0026418%20L16%2C46.0030192%20L14%2C46.0030192%20L14%2C27.4012643%20C15.843%2C26.9522219%2017.214%2C25.2930654%2017.214%2C23.3208793%20C17.214%2C21.3476932%2015.843%2C19.6885367%2014%2C19.2394943%20L14%2C16.0001887%20L66%2C16.0001887%20L66%2C19.2394943%20C64.157%2C19.6885367%2062.786%2C21.3476932%2062.786%2C23.3208793%20C62.786%2C25.2930654%2064.157%2C26.9522219%2066%2C27.4012643%20L66%2C46.0030192%20L64%2C46.0030192%20L64%2C42.0026418%20C64%2C41.4495896%2063.553%2C41.0025474%2063%2C41.0025474%20L57%2C41.0025474%20L57%2C43.0027361%20L62%2C43.0027361%20L62%2C46.0030192%20L57%2C46.0030192%20L57%2C48.0032078%20L67%2C48.0032078%20C67.553%2C48.0032078%2068%2C47.5551656%2068%2C47.0031135%20L68%2C26.5211812%20C68%2C25.9691292%2067.553%2C25.5210869%2067%2C25.5210869%20C65.779%2C25.5210869%2064.786%2C24.5339938%2064.786%2C23.3208793%20C64.786%2C22.1077649%2065.779%2C21.1206718%2067%2C21.1206718%20L67%2C21.1206718%20Z%20M28%2C28.0013209%20L28%2C20.0005661%20C28%2C19.4475139%2027.553%2C19.0004717%2027%2C19.0004717%20L21%2C19.0004717%20C20.447%2C19.0004717%2020%2C19.4475139%2020%2C20.0005661%20L20%2C37.00217%20C20%2C37.5542221%2020.447%2C38.0022644%2021%2C38.0022644%20L24%2C38.0022644%20L24%2C36.0020757%20L22%2C36.0020757%20L22%2C21.0006604%20L26%2C21.0006604%20L26%2C28.0013209%20L28%2C28.0013209%20Z%20M58%2C36.0020757%20L57%2C36.0020757%20L57%2C38.0022644%20L59%2C38.0022644%20C59.553%2C38.0022644%2060%2C37.5542221%2060%2C37.00217%20L60%2C20.0005661%20C60%2C19.4475139%2059.553%2C19.0004717%2059%2C19.0004717%20L53%2C19.0004717%20C52.447%2C19.0004717%2052%2C19.4475139%2052%2C20.0005661%20L52%2C28.0013209%20L54%2C28.0013209%20L54%2C21.0006604%20L58%2C21.0006604%20L58%2C36.0020757%20Z%20M50%2C27.0012265%20L50%2C20.0005661%20C50%2C19.4475139%2049.553%2C19.0004717%2049%2C19.0004717%20L42%2C19.0004717%20C41.447%2C19.0004717%2041%2C19.4475139%2041%2C20.0005661%20L41%2C26.0011322%20L43%2C26.0011322%20L43%2C21.0006604%20L48%2C21.0006604%20L48%2C27.0012265%20L50%2C27.0012265%20Z%20M37%2C26.0011322%20L37%2C21.0006604%20L32%2C21.0006604%20L32%2C27.0012265%20L30%2C27.0012265%20L30%2C20.0005661%20C30%2C19.4475139%2030.447%2C19.0004717%2031%2C19.0004717%20L38%2C19.0004717%20C38.553%2C19.0004717%2039%2C19.4475139%2039%2C20.0005661%20L39%2C26.0011322%20L37%2C26.0011322%20Z%22%20id%3D%22Amazon-ElastiCache_Icon_64_Squid%22%20fill%3D%22%23FFFFFF%22%3E%3C%2Fpath%3E%0A%20%20%20%20%3C%2Fg%3E%0A%3C%2Fsvg%3E"
)

type ElasticacheClusterAttackState struct {
	ReplicationGroupID string
	NodeGroupID        string
	Account            string
}

type ElasticacheApi interface {
	TestFailover(ctx context.Context, params *elasticache.TestFailoverInput, optFns ...func(*elasticache.Options)) (*elasticache.TestFailoverOutput, error)
	DescribeReplicationGroups(ctx context.Context, params *elasticache.DescribeReplicationGroupsInput, optFns ...func(*elasticache.Options)) (*elasticache.DescribeReplicationGroupsOutput, error)
}

func defaultElasticacheClientProvider(account string) (ElasticacheApi, error) {
	awsAccount, err := utils.Accounts.GetAccount(account)
	if err != nil {
		return nil, err
	}
	return elasticache.NewFromConfig(awsAccount.AwsConfig), nil
}
